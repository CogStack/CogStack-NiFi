name: submodules-sync

on:

  push:
    branches: ['**']
    tags: ['v*.*.*']
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    name: 'Submodules Sync'
    runs-on: ubuntu-latest
    
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:

    - name: Checkout
      uses: actions/checkout@v6
      with:
        token: ${{ github.token }}
        submodules: recursive
        fetch-depth: 0

    - name: Sync submodules using repository script
      id: sync_submodules
      run: |
        set -euo pipefail
        before_sha="$(git rev-parse HEAD)"

        # script may create a commit when submodule pointers change
        git config user.name  "Git bot"
        git config user.email "bot@noreply.github.com"
        ./scripts/git_update_submodules_in_repo.sh

        after_sha="$(git rev-parse HEAD)"
        if [ "$before_sha" != "$after_sha" ]; then
          echo "changed=true" >> "$GITHUB_OUTPUT"
          git show --no-patch --oneline "$after_sha"
        else
          echo "changed=false" >> "$GITHUB_OUTPUT"
          echo "No submodule pointer changes."
        fi

    - name: Push sync commit
      if: startsWith(github.ref, 'refs/heads/') && steps.sync_submodules.outputs.changed == 'true'
      run: git push origin HEAD:${GITHUB_REF##refs/heads/}
