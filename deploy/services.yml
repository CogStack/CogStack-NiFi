#---------------------------------------------------------------------------#
# Common snippets / anchors                                                 #
#---------------------------------------------------------------------------#
x-es-logging-common: &es-logging-common
  driver: "json-file"
  options:
    max-size: ${ELASTICSEARCH_DOCKER_LOG_SIZE_PER_FILE:-1000m}
    max-file: ${ELASTICSEARCH_DOCKER_LOG_NUM_FILES:-10}

x-nifi-logging-common: &nifi-logging-common
  driver: "json-file"
  options:
    max-size: ${NIFI_DOCKER_LOG_SIZE_PER_FILE:-250m}
    max-file: ${NIFI_DOCKER_LOG_NUM_FILES:-10}

x-logging-common: &logging-common
  driver: "json-file"
  options:
    max-size: ${DOCKER_LOG_SIZE_PER_FILE:-100m}
    max-file: ${DOCKER_LOG_NUM_FILES:-10}

x-all-env: &all-env
  - ./project.env
  - ./general.env
  - ./nifi.env
  - ./gitea.env
  - ./nginx.env
  - ./database.env
  - ./elasticsearch.env
  - ./network_settings.env
  - ../security/env/users_nifi.env
  - ../security/env/users_database.env
  - ../security/env/users_nginx.env
  - ../security/env/users_elasticsearch.env
  - ../security/env/certificates_general.env
  - ../security/env/certificates_elasticsearch.env
  - ../security/env/certificates_nifi.env

x-es-env: &es-env
  - ./network_settings.env
  - ./elasticsearch.env
  - ../security/env/users_elasticsearch.env
  - ../security/env/certificates_elasticsearch.env

x-db-env: &db-env
  - ./database.env
  - ../security/env/users_database.env

x-common-hosts: &common-hosts
  - ${ELASTICSEARCH_1_HOST_NAME:-test-1:0.0.0.0}
  - ${ELASTICSEARCH_2_HOST_NAME:-test-2:0.0.0.0}
  - ${ELASTICSEARCH_3_HOST_NAME:-test-3:0.0.0.0}
  - ${KIBANA_HOST_NAME:-test-4:0.0.0.0}
  - ${NIFI_HOST_NAME:-test-5:0.0.0.0}
  - ${NIFI_REGISTRY_HOST_NAME:-test-6:0.0.0.0}

x-common-ulimits: &common-ulimits
  ulimits:
    nofile:
      soft: 65535
      hard: 65535
    nproc: 65535
    memlock:
      soft: -1
      hard: -1

x-nifi-common: &nifi-common
  <<: *common-ulimits
  restart: unless-stopped
  env_file: *all-env
  extra_hosts: *common-hosts
  networks:
    - cognet

x-nifi-volumes: &nifi-volumes
  # Drivers
  - ../nifi/drivers:/opt/nifi/drivers

  # User overrides bundled in the image
  - ../nifi/user_scripts:/opt/nifi/user_scripts:rw
  - ../nifi/user_schemas:/opt/nifi/user_schemas:rw

  # Python processors (NiFi 2.x)
  - ../nifi/user_python_extensions:/opt/nifi/nifi-current/python_extensions:rw

  # Security certificates
  - ../security:/security:ro

  # Security helper scripts
  - ../security/scripts/nifi_create_single_user_auth.sh:/opt/nifi/nifi-current/security_scripts/nifi_create_single_user_auth.sh:ro

  # NiFi configuration
  - ../nifi/conf/:/opt/nifi/nifi-current/conf/:ro

  # Ingest data directory
  - ./${NIFI_DATA_PATH:-../data/}:/data/:rw

  # DB schemas
  - ../services/cogstack-db/:/opt/cogstack-db/:rw

  # MedCAT models
  - ./${RES_MEDCAT_SERVICE_MODEL_PRODUCTION_PATH:-../services/cogstack-nlp/medcat-service/models/}:/opt/models:rw

  # NiFi repositories/state
  - nifi-vol-logs:/opt/nifi/nifi-current/logs
  - nifi-vol-provenance:/opt/nifi/nifi-current/provenance_repository
  - nifi-vol-database:/opt/nifi/nifi-current/database_repository
  - nifi-vol-flowfiles:/opt/nifi/nifi-current/flowfile_repository
  - nifi-vol-content:/opt/nifi/nifi-current/content_repository
  - nifi-vol-state:/opt/nifi/nifi-current/state

  # Flowfile error output
  - nifi-vol-errors:/opt/nifi/pipeline/flowfile-errors

x-nifi-registry-volumes: &nifi-registry-volumes
  # Registry configuration
  - ../nifi/nifi-registry/:/opt/nifi-registry/nifi-registry-current/conf/:ro

  # Security certificates
  - ../security:/security:ro

  # Registry persistence
  - nifi-registry-vol-database:/opt/nifi-registry/nifi-registry-current/database
  - nifi-registry-vol-flow-storage:/opt/nifi-registry/nifi-registry-current/flow_storage
  - nifi-registry-vol-work:/opt/nifi-registry/nifi-registry-current/work
  - nifi-registry-vol-logs:/opt/nifi-registry/nifi-registry-current/logs

x-db-common: &db-common
  <<: *common-ulimits
  shm_size: ${DATABASE_DOCKER_SHM_SIZE:-"1g"}
  restart: unless-stopped
  env_file: *db-env
  deploy:
    resources:
      limits:
        cpus: "${DATABASE_DOCKER_CPU_MAX}"
        memory: "${DATABASE_DOCKER_RAM}"
      reservations:
        cpus: "${DATABASE_DOCKER_CPU_MIN}"
        memory: "${DATABASE_DOCKER_RAM}"

x-es-common-volumes: &es-common-volumes
  # Shared configs
  - ../services/elasticsearch/config/${ELASTICSEARCH_VERSION:-opensearch}.yml:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/${ELASTICSEARCH_VERSION:-opensearch}.yml:ro
  - ../services/elasticsearch/config/log4j2_${ELASTICSEARCH_VERSION:-opensearch}.properties:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/log4j2.properties:ro
  # Shared root CA + admin certs
  - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elastic-stack-ca.crt.pem:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/root-ca.crt:ro
  - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elastic-stack-ca.key.pem:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/root-ca.key:ro
  # OPENSEARCH specific (always mounted even if unused)
  - ../security/certificates/elastic/opensearch/admin.crt:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/admin.crt:ro
  - ../security/certificates/elastic/opensearch/admin.key.pem:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/admin.key.pem:ro
  # Shared roles
  - ../security/es_roles/elasticsearch/role_mapping.yml:/usr/share/elasticsearch/config/role_mapping.yml:ro
  - ../security/es_roles/elasticsearch/roles.yml:/usr/share/elasticsearch/config/roles.yml:ro
  - ../security/es_roles/opensearch/config.yml:/usr/share/opensearch/config/opensearch-security/config.yml:ro
  - ../security/es_roles/opensearch/internal_users.yml:/usr/share/opensearch/config/opensearch-security/internal_users.yml:ro
  - ../security/es_roles/opensearch/roles_mapping.yml:/usr/share/opensearch/config/opensearch-security/roles_mapping.yml:ro
  - ../security/es_roles/opensearch/roles.yml:/usr/share/opensearch/config/opensearch-security/roles.yml:ro
  # Shared system settings
  - ../services/elasticsearch/sysctl.conf:/etc/sysctl.conf:ro
  # Shared snapshot mounts
  - ${ELASTICSEARCH_BACKUP_PARTITION_FULL:-../data/es_snapshot_backups/full_backup}:/mnt/es_data_backups:rw
  - ${ELASTICSEARCH_BACKUP_PARTITION_CONFIG:-../data/es_snapshot_backups/config_backup}:/mnt/es_config_backups:rw

x-es-common: &es-common
  <<: *common-ulimits
  image: ${ELASTICSEARCH_DOCKER_IMAGE:-opensearchproject/opensearch:3.3.0}
  shm_size: ${ELASTICSEARCH_DOCKER_SHM_SIZE:-1g}
  restart: unless-stopped
  env_file: *es-env
  networks:
    - cognet
  extra_hosts: *common-hosts
  environment:
    ES_JAVA_OPTS: ${ELASTICSEARCH_JAVA_OPTS:--Xms2048m -Xmx2048m -Des.failure_store_feature_flag_enabled=true}
    OPENSEARCH_JAVA_OPTS: ${ELASTICSEARCH_JAVA_OPTS:--Xms2048m -Xmx2048m -Des.failure_store_feature_flag_enabled=true}
    ELASTIC_USER: ${ELASTIC_USER:-elastic}
    ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-kibanaserver}
    OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-kibanaserver}
    ELASTICSEARCH_VERSION: ${ELASTICSEARCH_VERSION:-opensearch}
  logging: *es-logging-common
  deploy:
    resources:
      limits:
        cpus: "${ELASTICSEARCH_DOCKER_CPU_MAX}"
        memory: "${ELASTICSEARCH_DOCKER_RAM}"
      reservations:
        cpus: "${ELASTICSEARCH_DOCKER_CPU_MIN}"
        memory: "${ELASTICSEARCH_DOCKER_RAM}"

x-metricbeat-common: &metricbeat-common
  <<: *common-ulimits
  image: ${METRICBEAT_IMAGE:-docker.elastic.co/beats/metricbeat:8.18.2}
  command: -e --strict.perms=false
  restart: unless-stopped
  shm_size: ${METRICBEAT_DOCKER_SHM:-1g}
  env_file:
    - ./elasticsearch.env
    - ../security/env/users_elasticsearch.env
  environment:
    - ELASTICSEARCH_HOSTS=${ELASTICSEARCH_HOSTS:-["https://elasticsearch-1:9200","https://elasticsearch-2:9200"]}
    - METRICBEAT_USER=${METRICBEAT_USER:-elastic}
    - METRICBEAT_PASSWORD=${METRICBEAT_PASSWORD:-kibanaserver}
    - KIBANA_HOST=${KIBANA_HOST:-"https://kibana:5601"}
  deploy:
    resources:
      limits:
        cpus: "${METRICBEAT_DOCKER_CPU_MAX}"
        memory: "${METRICBEAT_DOCKER_RAM}"
      reservations:
        cpus: "${METRICBEAT_DOCKER_CPU_MIN}"
        memory: "${METRICBEAT_DOCKER_RAM}"
  volumes:
    - ../services/metricbeat/metricbeat.yml:/usr/share/metricbeat/metricbeat.yml:ro
    - ../security/certificates/elastic/elasticsearch/elastic-stack-ca.crt.pem:/usr/share/metricbeat/root-ca.crt:ro
    - ../security/certificates/elastic/elasticsearch/elastic-stack-ca.key.pem:/usr/share/metricbeat/root-ca.key:ro
  networks:
    - cognet
  extra_hosts: *common-hosts
  logging: *es-logging-common

x-filebeat-common: &filebeat-common
  <<: *common-ulimits
  image: ${FILEBEAT_IMAGE:-docker.elastic.co/beats/filebeat:8.18.2}
  command: ${FILEBEAT_STARTUP_COMMAND:-'-e --strict.perms=false'}
  restart: unless-stopped
  shm_size: ${FILEBEAT_DOCKER_SHM:-1g}
  env_file:
    - ./elasticsearch.env
    - ../security/env/users_elasticsearch.env
  environment:
    - ELASTICSEARCH_HOSTS=${ELASTICSEARCH_HOSTS:-["https://elasticsearch-1:9200","https://elasticsearch-2:9200"]}
    - FILEBEAT_USER=${FILEBEAT_USER:-elastic}
    - FILEBEAT_PASSWORD=${FILEBEAT_PASSWORD:-kibanaserver}
    - KIBANA_HOST=${KIBANA_HOST:-"https://kibana:5601"}
  deploy:
    resources:
      limits:
        cpus: "${FILEBEAT_DOCKER_CPU_MAX}"
        memory: "${FILEBEAT_DOCKER_RAM}"
      reservations:
        cpus: "${FILEBEAT_DOCKER_CPU_MIN}"
        memory: "${FILEBEAT_DOCKER_RAM}"
  volumes:
    - ../services/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:rw
    - ../security/certificates/elastic/elasticsearch/elastic-stack-ca.crt.pem:/etc/pki/root/root-ca.crt:ro
    - ../security/certificates/elastic/elasticsearch/elastic-stack-ca.key.pem:/etc/pki/root/root-ca.key:ro
  networks:
    - cognet
  extra_hosts: *common-hosts
  logging: *es-logging-common

#---------------------------------------------------------------------------#
# Used services                                                             #
#---------------------------------------------------------------------------#
services:

#---------------------------------------------------------------------------#
# Postgres container with sample data                                       #
#---------------------------------------------------------------------------#
  samples-db:
    <<: *db-common
    image: postgres:17.5-alpine
    container_name: cogstack-samples-db
    platform: linux/amd64
    environment:
      # PG env vars
      - POSTGRES_USER=${POSTGRES_USER_SAMPLES:-test}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD_SAMPLES:-test}
    volumes:
      # mapping postgres data dump and initialization
      - ../services/pgsamples/db_dump:/data/db_dump:rw
      - ../services/pgsamples/schemas:/data/schemas:rw
      - ../services/pgsamples/init_db.sh:/docker-entrypoint-initdb.d/init_db.sh:ro
      # data persistence
      - samples-vol:/var/lib/postgresql/data
    command: postgres -c "max_connections=${POSTGRES_DB_MAX_CONNECTIONS:-100}"
    ports:
      - 5554:5432
    expose:
      - 5432
    networks:
      - cognet

#---------------------------------------------------------------------------#
# CogStack Databank / Cogstack-DB, production database                      #
#---------------------------------------------------------------------------#
  cogstack-databank-db:
    <<: *db-common
    image: postgres:17.5-alpine
    container_name: cogstack-production-databank-db
    platform: linux/amd64
    environment:
      - POSTGRES_USER=${DATABASE_USER:-admin}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD:-admin}
      - POSTGRES_DATABANK_DB=${DATABASE_DB_NAME:-cogstack}
    volumes:
      # mapping postgres data dump and initialization
      - ../services/cogstack-db/pgsql/schemas:/data/:ro
      - ../services/cogstack-db/pgsql/init_db.sh:/docker-entrypoint-initdb.d/init_db.sh:ro
      # data persistence
      - databank-vol:/var/lib/postgresql/data
    command: postgres -c "max_connections=${POSTGRES_DB_MAX_CONNECTIONS:-100}"
    ports:
      - 5558:5432
    expose:
      - 5432
    networks:
      - cognet
  
  cogstack-databank-db-mssql:
    <<: *db-common
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: cogstack-production-databank-db-mssql
    environment:
      - ACCEPT_EULA=y
      - MSSQL_SA_USER=${MSSQL_SA_USER:-sa}
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD:-admin!COGSTACK2022}
    volumes:
      # mapping postgres data dump and initialization
      - ../services/cogstack-db/mssql/schemas:/data/:ro
      - ../services/cogstack-db/mssql/init_db.sh:/usr/src/app/init_db.sh:ro
      # data persistence
      - databank-vol:/var/opt/mssql
    entrypoint: "nohup bash -c '/usr/src/app/init_db.sh'"
    ports:
      - 1433:1433
    networks:
      - cognet

#---------------------------------------------------------------------------#
# ElasticSearch cluster                                                     #
#---------------------------------------------------------------------------#
  es_native_create_certs:
    container_name: es_create_certs
    image: docker.elastic.co/elasticsearch/elasticsearch:8.18.2
    shm_size: ${ELASTICSEARCH_DOCKER_SHM_SIZE:-1g}
    env_file: *es-env
    restart: "no"
    command: bash -c "bash /usr/share/elasticsearch/es_native_cert_generator.sh"
    stdin_open: true 
    tty: true
    user: "0"
    working_dir: /usr/share/elasticsearch
    volumes:
      - ../security/scripts/es_native_cert_generator.sh:/usr/share/elasticsearch/es_native_cert_generator.sh:ro
      - ../security/certificates/elastic/elasticsearch:/usr/share/elasticsearch/config/certificates:rw
      - elasticsearch-certs-vol:/certs

  elasticsearch-base:
    <<: *es-common
    profiles: ["_elasticsearch_base"]
    volumes: *es-common-volumes

  elasticsearch-1:
    extends:
      service: elasticsearch-base
    container_name: elasticsearch-1
    environment:
      node.name: ${ELASTICSEARCH_NODE_1_NAME:-es01}
    volumes:
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.p12:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.p12:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.crt:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.crt:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.key:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.key:ro
      # ES data persistence
      - ${ELASTICSEARCH_NODE_1_DATA_VOL_NAME:-elasticsearch-vol-1}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/data
      # ES logs
      - ${ELASTICSEARCH_NODE_1_LOG_VOL_NAME:-elasticsearch-vol-log-1}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/logs
    ports:
      - "${ELASTICSEARCH_NODE_1_OUTPUT_PORT:-9200}:9200"
      - "${ELASTICSEARCH_NODE_1_COMM_OUTPUT_PORT:-9300}:9300"
      - "${ELASTICSEARCH_NODE_1_ANALYZER_OUTPUT_PORT:-9600}:9600"

  elasticsearch-2:
    extends:
      service: elasticsearch-base
    container_name: elasticsearch-2
    environment:
      node.name: ${ELASTICSEARCH_NODE_2_NAME:-es02}
    volumes:
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.p12:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.p12:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.crt:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.crt:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.key:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.key:ro
      # ES data persistence
      - ${ELASTICSEARCH_NODE_2_DATA_VOL_NAME:-elasticsearch-vol-2}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/data
      # ES logs
      - ${ELASTICSEARCH_NODE_2_LOG_VOL_NAME:-elasticsearch-vol-log-2}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/logs
    ports:
      - "${ELASTICSEARCH_NODE_2_OUTPUT_PORT:-9201}:9200"
      - "${ELASTICSEARCH_NODE_2_COMM_OUTPUT_PORT:-9301}:9300"
      - "${ELASTICSEARCH_NODE_2_ANALYZER_OUTPUT_PORT:-9601}:9600"

  elasticsearch-3:
    extends:
      service: elasticsearch-base
    container_name: elasticsearch-3
    environment:
      node.name: ${ELASTICSEARCH_NODE_3_NAME:-es03}
    volumes:
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.p12:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.p12:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.crt:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.crt:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.key:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/config/esnode.key:ro
      # ES data persistence
      - ${ELASTICSEARCH_NODE_3_DATA_VOL_NAME:-elasticsearch-vol-3}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/data
      # ES logs
      - ${ELASTICSEARCH_NODE_3_LOG_VOL_NAME:-elasticsearch-vol-log-3}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/logs
    ports:
      - "${ELASTICSEARCH_NODE_3_OUTPUT_PORT:-9202}:9200"
      - "${ELASTICSEARCH_NODE_3_COMM_OUTPUT_PORT:-9302}:9300"
      - "${ELASTICSEARCH_NODE_3_ANALYZER_OUTPUT_PORT:-9602}:9600"

  metricbeat-1:
    <<: *metricbeat-common
    container_name: cogstack-metricbeat-1
    volumes:
      - metricbeat-data-1:/usr/share/metricbeat/data
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.p12:/usr/share/metricbeat/esnode.p12:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.crt:/usr/share/metricbeat/esnode.crt:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.key:/usr/share/metricbeat/esnode.key:ro

  metricbeat-2:
    <<: *metricbeat-common
    container_name: cogstack-metricbeat-2
    volumes:
      - metricbeat-data-2:/usr/share/metricbeat/data
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.p12:/usr/share/metricbeat/esnode.p12:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.crt:/usr/share/metricbeat/esnode.crt:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.key:/usr/share/metricbeat/esnode.key:ro

  metricbeat-3:
    <<: *metricbeat-common
    container_name: cogstack-metricbeat-3
    volumes:
      - metricbeat-data-3:/usr/share/metricbeat/data
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.p12:/usr/share/metricbeat/esnode.p12:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.crt:/usr/share/metricbeat/esnode.crt:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.key:/usr/share/metricbeat/esnode.key:ro

  filebeat-1:
    <<: *filebeat-common
    container_name: cogstack-filebeat-1
    volumes:
      - filebeat-data-1:/usr/share/filebeat/data
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.p12:/etc/pki/client/esnode.p12:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.crt:/etc/pki/client/esnode.crt:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.key:/etc/pki/client/esnode.key:ro
      - ${ELASTICSEARCH_NODE_1_LOG_VOL_NAME:-elasticsearch-vol-log-1}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/logs

  filebeat-2:
    <<: *filebeat-common
    container_name: cogstack-filebeat-2
    volumes:
      - filebeat-data-2:/usr/share/filebeat/data
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.p12:/etc/pki/client/esnode.p12:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.crt:/etc/pki/client/esnode.crt:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_2:-elasticsearch-2}/${ES_INSTANCE_NAME_2:-elasticsearch-2}.key:/etc/pki/client/esnode.key:ro
      - ${ELASTICSEARCH_NODE_2_LOG_VOL_NAME:-elasticsearch-vol-log-2}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/logs

  filebeat-3:
    <<: *filebeat-common
    container_name: cogstack-filebeat-3
    volumes:
      - filebeat-data-3:/usr/share/filebeat/data
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.p12:/etc/pki/client/esnode.p12:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.crt:/etc/pki/client/esnode.crt:ro
      - ../security/certificates/elastic/elasticsearch/elasticsearch/${ES_INSTANCE_NAME_3:-elasticsearch-3}/${ES_INSTANCE_NAME_3:-elasticsearch-3}.key:/etc/pki/client/esnode.key:ro
      - ${ELASTICSEARCH_NODE_3_LOG_VOL_NAME:-elasticsearch-vol-log-3}:/usr/share/${ELASTICSEARCH_VERSION:-opensearch}/logs

#---------------------------------------------------------------------------#
# Kibana webapp                                                             #
#---------------------------------------------------------------------------#
  kibana:
    <<: *common-ulimits
    image: ${ELASTICSEARCH_KIBANA_DOCKER_IMAGE:-opensearchproject/opensearch-dashboards:3.3.0}
    container_name: cogstack-kibana
    shm_size: ${KIBANA_DOCKER_SHM_SIZE:-1g}
    restart: always
    env_file: *es-env
    environment:
      # INFO: use HTTPS instead of HTTP when enabled SSL
      OPENSEARCH_HOSTS: ${ELASTICSEARCH_HOSTS:-'["https://elasticsearch-1:9200","https://elasticsearch-2:9200"]'}
      ELASTICSEARCH_HOSTS: ${ELASTICSEARCH_HOSTS:-'["https://elasticsearch-1:9200","https://elasticsearch-2:9200"]'}
      # INFO: uncomment below to enable SSL keys
      SERVER_SSL_ENABLED: ${ELASTICSEARCH_SSL_ENABLED:-"true"}
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-kibanaserver}
    deploy:
      resources:
        limits:
          cpus: "${KIBANA_DOCKER_CPU_MAX}"
          memory: "${KIBANA_DOCKER_RAM}"
        reservations:
          cpus: "${KIBANA_DOCKER_CPU_MIN}"
          memory: "${KIBANA_DOCKER_RAM}"
    volumes:
      # INFO: Kibana configuration mapped via volume (make sure to comment this and uncomment the next line if you are using NATIVE kibana deployment)
      - ../services/kibana/config/${ELASTICSEARCH_VERSION:-opensearch}.yml:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/${KIBANA_CONFIG_FILE_VERSION:-opensearch_dashboards}.yml:ro

      # Security certificates, general
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elastic-stack-ca.crt.pem:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/root-ca.crt:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elastic-stack-ca.key.pem:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/root-ca.key:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elastic-stack-ca.p12:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/root-ca.p12:ro

      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.crt:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/esnode1.crt:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.key:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/esnode1.key:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/${ES_INSTANCE_NAME_1:-elasticsearch-1}.p12:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/esnode1.p12:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/http-${ES_INSTANCE_NAME_1:-elasticsearch-1}.csr:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/http-esnode1.csr:ro
      - ../security/certificates/elastic/${ELASTICSEARCH_VERSION:-opensearch}/elasticsearch/${ES_INSTANCE_NAME_1:-elasticsearch-1}/http-${ES_INSTANCE_NAME_1:-elasticsearch-1}.key:/usr/share/${KIBANA_VERSION:-opensearch-dashboards}/config/http-esnode1.key:ro

      # OpenSearch uses some default certs
      - ../security/certificates:/certificates:ro
    ports:
      - "${KIBANA_SERVER_OUTPUT_PORT:-5601}:5601"
    networks:
      - cognet
    extra_hosts: *common-hosts
    logging: *es-logging-common

#---------------------------------------------------------------------------#
# NiFi webapp                                                               #
#---------------------------------------------------------------------------#
  nifi:
    <<: *nifi-common
    image: cogstacksystems/cogstack-nifi:latest
    container_name: cogstack-nifi
    hostname: nifi
    shm_size: ${NIFI_DOCKER_SHM_SIZE:-"1g"}
    environment:
      - USER_ID=${NIFI_UID:-1000}
      - GROUP_ID=${NIFI_GID:-1000}
      - NIFI_WEB_PROXY_HOST=${NIFI_WEB_PROXY_HOST:-"localhost:8443"}
      - NIFI_WEB_PROXY_CONTEXT_PATH=${NIFI_WEB_PROXY_CONTEXT_PATH:-"/nifi"}
      - NIFI_INTERNAL_PORT=${NIFI_INTERNAL_PORT:-8443}
      - NIFI_OUTPUT_PORT=${NIFI_OUTPUT_PORT:-8082}
      - NIFI_INPUT_SOCKET_PORT=${NIFI_INPUT_SOCKET_PORT:-10000}
      - PYTHONPATH=${NIFI_PYTHONPATH:-/opt/nifi/nifi-current/python/framework}
      - JVM_OPTS="${NIFI_JVM_OPTS:--XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled -Djava.security.egd=file:/dev/./urandom}"
    deploy:
      resources:
        limits:
          cpus: "${NIFI_DOCKER_CPU_MAX}"
          memory: "${NIFI_DOCKER_RAM}"
        reservations:
          cpus: "${NIFI_DOCKER_CPU_MIN}"
          memory: "${NIFI_DOCKER_RAM}"
    volumes: *nifi-volumes

    # INFO : Uncomment the below line to generate your own USERNAME and PASSWORD,
    #        a bit messy this way as you will need to copy the credentials back
    #        to the "login-identity-providers.xml" section.
    # entrypoint: bash -c "/opt/nifi/nifi-current/bin/nifi.sh set-single-user-credentials admin admincogstacknifi"
    tty: true
    ports:
      - "${NIFI_OUTPUT_PORT:-8082}:${NIFI_INTERNAL_PORT:-8443}"
      - "${NIFI_INPUT_SOCKET_PORT:-10000}"
    logging: *nifi-logging-common
 
  nifi-registry-flow:
    <<: *nifi-common
    image: apache/nifi-registry:${NIFI_REGISTRY_VERSION:-2.7.2}
    hostname: nifi-registry
    container_name: cogstack-nifi-registry-flow
    shm_size: ${NIFI_DOCKER_REGISTRY_SHM_SIZE:-1g}
    user: root
    environment:
      - http_proxy=$HTTP_PROXY
      - https_proxy=$HTTPS_PROXY
      - no_proxy=$no_proxy
      - USER_ID=${NIFI_UID:-1000}
      - GROUP_ID=${NIFI_GID:-1000}
      - KEYSTORE_PATH=${NIFI_REGISTRY_KEYSTORE_PATH:-/security/certificates/nifi/nifi-keystore.jks}
      - KEYSTORE_TYPE=${NIFI_KEYSTORE_TYPE:-jks}
      - KEYSTORE_PASSWORD=${NIFI_KEYSTORE_PASSWORD:-"cogstackNifi"}
      - TRUSTSTORE_PASSWORD=${NIFI_TRUSTSTORE_PASSWORD:-"cogstackNifi"}
      - TRUSTSTORE_PATH=${NIFI_REGISTRY_TRUSTSTORE_PATH:-/security/certificates/nifi/nifi-truststore.jks}

      - TRUSTSTORE_TYPE=${NIFI_TRUSTSTORE_TYPE:-jks}
      - INITIAL_ADMIN_IDENTITY=${NIFI_INITIAL_ADMIN_IDENTITY:-"cogstack"}
      - AUTH=${NIFI_AUTH:-"tls"}
      - NIFI_REGISTRY_DB_DIR=${NIFI_REGISTRY_DB_DIR:-/opt/nifi-registry/nifi-registry-current/database}
      #- NIFI_REGISTRY_FLOW_PROVIDER=${NIFI_REGISTRY_FLOW_PROVIDER:-file}
      - NIFI_REGISTRY_FLOW_STORAGE_DIR=${NIFI_REGISTRY_FLOW_STORAGE_DIR:-/opt/nifi-registry/nifi-registry-current/flow_storage}
    deploy:
      resources:
        limits:
          cpus: "${NIFI_REGISTRY_DOCKER_CPU_MAX}"
          memory: "${NIFI_REGISTRY_DOCKER_RAM}"
        reservations:
          cpus: "${NIFI_REGISTRY_DOCKER_CPU_MIN}"
          memory: "${NIFI_REGISTRY_DOCKER_RAM}"
    volumes: *nifi-registry-volumes
    extra_hosts: *common-hosts
    tty: true
    ports:
      - "${NIFI_REGISTRY_FLOW_OUTPUT_PORT:-8083}:${NIFI_REGISTRY_FLOW_INPUT_PORT:-18443}"
    
    entrypoint: bash -c "chown -R nifi:nifi /opt/nifi-registry/nifi-registry-current/database && \
      chown -R nifi:nifi /opt/nifi-registry/nifi-registry-current/flow_storage && \
      chown -R nifi:nifi /opt/nifi-registry/nifi-registry-current/work && \
      chown -R nifi:nifi /opt/nifi-registry/nifi-registry-current/logs && \
      bash /opt/nifi-registry/scripts/start.sh"
    logging: *nifi-logging-common
  
  nifi-nginx:
    image: cogstacksystems/nifi-nginx:latest
    container_name: cogstack-nifi-nginx
    restart: always
    shm_size: ${NGINX_SHM_SIZE:-1g}
    env_file: *all-env
    deploy:
      resources:
        limits:
          cpus: "${NGINX_DOCKER_CPU_MAX}"
          memory: "${NGINX_DOCKER_RAM}"
        reservations:
          cpus: "${NGINX_DOCKER_CPU_MIN}"
          memory: "${NGINX_DOCKER_RAM}"
    volumes:
      - ../services/nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ../services/nginx/config/nginx.conf.template:/etc/nginx/config/nginx.conf.template:rw
      - ../services/nginx/config/nginx.conf:/etc/nginx/nginx.conf:rw
      - ../security/certificates:/certificates:ro
    ports:
      - "${NIFI_EXTERNAL_PORT_NGINX:-8443}:${NIFI_INTERNAL_PORT_NGINX:-8443}"
      - "${NIFI_REGISTRY_EXTERNAL_PORT_NGINX:-18443}:${NIFI_REGISTRY_INTERNAL_PORT_NGINX:-18443}"
    networks:
      - cognet
    command: /bin/bash -c "envsubst < /etc/nginx/config/nginx.conf.template > /etc/nginx/config/nginx.conf && nginx -g 'daemon off;'"
    extra_hosts: *common-hosts
    logging: *nifi-logging-common

#---------------------------------------------------------------------------#
# Cogstack cohort service                                                   #
#---------------------------------------------------------------------------#
  cogstack-cohort:
      container_name: cogstack-cohort
      image: cogstacksystems/cogstackcohort:latest
      shm_size: ${DOCKER_SHM_SIZE:-"1g"}
      restart: always
      env_file: *all-env
      volumes:
        - ./../data/cogstack-cohort:/usr/src/app/server/data:rw
        - ./../services/cogstack-cohort/cui_pt2ch.json:/usr/src/app/server/data/cui_pt2ch.json:rw
        - ./../services/cogstack-cohort/snomed_terms.json:/usr/src/app/server/data/snomed_terms.json:rw
      networks:
        - cognet
      ports:
        - "3001:3000"
      logging: *logging-common

#---------------------------------------------------------------------------#
# Version control service                                                   #
#---------------------------------------------------------------------------#
  gitea:
    <<: *common-ulimits
    container_name: cogstack-gitea
    image:  gitea/gitea:1.23-rootless
    shm_size: ${GITEA_DOCKER_SHM_SIZE:-"1g"}
    restart: always
    environment:
      - http_proxy=$HTTP_PROXY
      - https_proxy=$HTTPS_PROXY
      - no_proxy=$no_proxy
    deploy:
      resources:
        limits:
          cpus: "${GITEA_DOCKER_CPU_MAX}"
          memory: "${GITEA_DOCKER_RAM}"
        reservations:
          cpus: "${GITEA_DOCKER_CPU_MIN}"
          memory: "${GITEA_DOCKER_RAM}"
    volumes:
      # app config
      - ../services/gitea/app.ini:/etc/gitea/app.ini:rw
      # certificates
      - ../security/certificates:/certificates:ro
      # data & conf volumes
      - gitea-config-vol:/etc/gitea:rw
      - gitea-lib-vol:/var/lib/gitea:rw
      - gitea-data-vol:/data:rw
    networks:
      - cognet
    ports:
      - "3000:3000"
      - "2222:22"
    logging: *logging-common

#---------------------------------------------------------------------------#
# Docker named volumes                                                      #
#---------------------------------------------------------------------------#
volumes:
  samples-vol:
    driver: local

  databank-vol:
    driver: local

  # ELK-stack related
  elasticsearch-vol-1:
    driver: local
  elasticsearch-vol-2:
    driver: local
  elasticsearch-vol-3:
    driver: local
  elasticsearch-certs-vol:
    driver: local
  
  elasticsearch-vol-log-1:
    driver: local
  elasticsearch-vol-log-2:
    driver: local
  elasticsearch-vol-log-3:
    driver: local

  metricbeat-data-1:
    driver: local
  metricbeat-data-2:
    driver: local
  metricbeat-data-3:
    driver: local

  filebeat-data-1:
    driver: local
  filebeat-data-2:
    driver: local
  filebeat-data-3:
    driver: local

  # NiFi related
  nifi-vol-logs:
    driver: local

  nifi-vol-provenance:
    driver: local

  nifi-vol-database:
    driver: local

  nifi-vol-flowfiles:
    driver: local

  nifi-vol-content:
    driver: local
  
  nifi-vol-state:
    driver: local

  nifi-vol-errors:
    driver: local

  nifi-registry-vol-database:
    driver: local
  nifi-registry-vol-flow-storage:
    driver: local
  nifi-registry-vol-work:
    driver: local
  nifi-registry-vol-logs:
    driver: local

  # Gitea
  gitea-lib-vol:
    driver: local
  gitea-config-vol:
    driver: local
  gitea-data-vol:
    driver: local

#---------------------------------------------------------------------------#
# Docker networks.                                                          #
#---------------------------------------------------------------------------#
networks:
  cognet:
    driver: bridge
    name: cogstack-net
